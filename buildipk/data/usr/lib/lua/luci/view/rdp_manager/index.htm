<%+header%>

<style>
    #cbi-rdp .cbi-section-table-row:hover,
    #cbi-rdp .cbi-section-table-row:hover .cbi-section-table-cell {
        background-color: #e0f0ff !important;
        transition: background-color 0.1s ease-in-out;
    }
    .target-info-cell { font-family: monospace; line-height: 1.3; }
</style>

<div class="cbi-map" id="cbi-rdp">
    <h2 name="content">路由器自动化运维系统</h2>
    <div class="cbi-map-descr">配置内网设备的端口转发与静态 DHCP 绑定。</div>

    <fieldset class="cbi-section" id="cbi-add-rule">
        <legend>新建 / 修改规则</legend>
        <div class="cbi-section-node">
            <form id="rdp_form" onsubmit="return false;">
                <div class="cbi-value">
                    <label class="cbi-value-title">主机名称</label>
                    <div class="cbi-value-field"><input type="text" class="cbi-input-text" id="f_hostname" name="hostname"></div>
                </div>
                <div class="cbi-value">
                    <label class="cbi-value-title">规则名</label>
                    <div class="cbi-value-field"><input type="text" class="cbi-input-text" id="f_name" name="name" required></div>
                </div>
                <div class="cbi-value">
                    <label class="cbi-value-title">MAC 地址</label>
                    <div class="cbi-value-field"><input type="text" class="cbi-input-text" id="f_mac" name="mac" required></div>
                </div>
                <div class="cbi-value">
                    <label class="cbi-value-title">内网 IP</label>
                    <div class="cbi-value-field">
                        <select class="cbi-input-select" id="sel_int_ip" style="width:180px; margin-right:5px;" onchange="autoFillHost(this.value)">
                            <option value="">手动填入或选择...</option>
                            <% if known_hosts then for _, h in ipairs(known_hosts) do %>
                            <option value="<%=h.ip%>"><%=h.ip%> (<%=h.name ~= "" and h.name or h.mac%>)</option>
                            <% end end %>
                        </select>
                        <input type="text" class="cbi-input-text" id="f_int_ip" name="int_ip" style="width:120px;" value="192.168.128." required>
                    </div>
                </div>
                <div class="cbi-value">
                    <label class="cbi-value-title">内网目标端口</label>
                    <div class="cbi-value-field">
                        <select class="cbi-input-select" style="width:120px; margin-right:5px;" onchange="document.getElementById('f_int_port').value=this.value">
                            <option value="">手动填入或选择</option>
                            <option value="3389">3389 (RDP)</option>
                            <option value="22">22 (SSH)</option>
                            <option value="80">80 (HTTP)</option>
                            <option value="443">443 (HTTPS)</option>
                            <option value="8006">8006 (PVE)</option>
                        </select>
                        <input type="text" class="cbi-input-text" id="f_int_port" name="int_port" style="width:100px;" value="" required>
                    </div>
                </div>
                <div class="cbi-value">
                    <label class="cbi-value-title">来源限制 (IP)</label>
                    <div class="cbi-value-field"><input type="text" class="cbi-input-text" id="f_wan_ip" name="wan_ip" placeholder="留空为不限"></div>
                </div>
                <div class="cbi-value">
                    <label class="cbi-value-title">外部映射端口</label>
                    <div class="cbi-value-field">
                        <select class="cbi-input-select" style="width:120px; margin-right:5px;" onchange="document.getElementById('f_ext_port').value=this.value">
                            <option value="">手动填入或选择</option>
                            <option value="6666">6666 (RDP)</option>
                            <option value="6667">6667 (RDP)</option>
                            <option value="6668">6668 (RDP)</option>
                        </select>
                        <input type="text" class="cbi-input-text" id="f_ext_port" name="ext_port" style="width:100px;" required>
                    </div>
                </div>
                
                <div class="cbi-page-actions" style="border-top: none; text-align: left; padding-left: 33%;">
                    <input type="button" class="cbi-button cbi-button-apply" value="应用全量规则" onclick="submitRule('apply')">
                    <input type="button" class="cbi-button cbi-button-save" value="仅设静态DHCP" onclick="submitRule('dhcp')">
                    <input type="button" class="cbi-button cbi-button-add" value="仅设转发规则" onclick="submitRule('fw')">
                    <span id="sys_msg" style="margin-left: 15px; font-weight: bold; color: #cc0000;"></span>
                </div>
            </form>
        </div>
    </fieldset>

    <fieldset class="cbi-section">
        <legend>RDP 专用规则 (6666-6668)</legend>
        <div class="cbi-section-node">
            <table class="table cbi-section-table">
                <tr class="cbi-section-table-titles">
                    <th class="cbi-section-table-cell">规则名 / 主机</th>
                    <th class="cbi-section-table-cell">来源限制</th>
                    <th class="cbi-section-table-cell">映射关系</th>
                    <th class="cbi-section-table-cell">目标信息</th>
                    <th class="cbi-section-table-cell center">操作</th>
                </tr>
                <% if rdp_rules and #rdp_rules > 0 then %>
                    <% local rowstyle = 1 %>
                    <% for _, r in ipairs(rdp_rules) do %>
                    <tr class="cbi-section-table-row cbi-rowstyle-<%=rowstyle%>">
                        <td class="cbi-section-table-cell">
                            <strong><%=r.name%></strong><br>
                            <span style="color:#666; font-size:0.9em;"><%=r.hostname%></span>
                        </td>
                        <td class="cbi-section-table-cell" style="color:#d63384; font-family:monospace;"><%=r.src_ip_display%></td>
                        <td class="cbi-section-table-cell"><strong><%=r.src_dport%></strong> &rarr; <%=r.dest_port%></td>
                        <td class="cbi-section-table-cell target-info-cell">
                            <span style="color:#0066cc; font-weight:bold;"><%=r.dest_ip%></span><br>
                            <span style="background:#f0f0f0; padding:1px 3px; border-radius:3px; font-size: 0.9em;"><%=r.mac%></span><br>
                            <span style="font-size:0.85em; color:<% if r.ip_type=='静态绑定' then %>#28a745<% else %>#6c757d<% end %>;"><%=r.ip_type%></span>
                        </td>
                        <td class="cbi-section-table-cell center">
                            <input type="button" class="cbi-button cbi-button-edit" value="修改" onclick="editR('<%=r.hostname%>','<%=r.name%>','<%=r.mac%>','<%=r.dest_ip%>','<%=r.src_ip_display%>','<%=r.src_dport%>','<%=r.dest_port%>')">
                            <input type="button" class="cbi-button cbi-button-remove" value="删除" onclick="delR('<%=r.index%>','<%=r.mac_id%>')">
                        </td>
                    </tr>
                    <% rowstyle = (rowstyle == 1) and 2 or 1 %>
                    <% end %>
                <% else %>
                    <tr class="cbi-section-table-row"><td colspan="5" class="center" style="color:#999;">暂无匹配的规则</td></tr>
                <% end %>
            </table>
        </div>
    </fieldset>

    <fieldset class="cbi-section">
        <legend>其他转发规则</legend>
        <div class="cbi-section-node">
            <table class="table cbi-section-table">
                <tr class="cbi-section-table-titles">
                    <th class="cbi-section-table-cell">规则名 / 主机</th>
                    <th class="cbi-section-table-cell">来源限制</th>
                    <th class="cbi-section-table-cell">映射关系</th>
                    <th class="cbi-section-table-cell">目标信息</th>
                    <th class="cbi-section-table-cell center">操作</th>
                </tr>
                <% if other_rules and #other_rules > 0 then %>
                    <% local rowstyle = 1 %>
                    <% for _, r in ipairs(other_rules) do %>
                    <tr class="cbi-section-table-row cbi-rowstyle-<%=rowstyle%>">
                        <td class="cbi-section-table-cell">
                            <strong><%=r.name%></strong><br>
                            <span style="color:#666; font-size:0.9em;"><%=r.hostname%></span>
                        </td>
                        <td class="cbi-section-table-cell" style="color:#d63384; font-family:monospace;"><%=r.src_ip_display%></td>
                        <td class="cbi-section-table-cell"><strong><%=r.src_dport%></strong> &rarr; <%=r.dest_port%></td>
                        <td class="cbi-section-table-cell target-info-cell">
                            <span style="color:#0066cc; font-weight:bold;"><%=r.dest_ip%></span><br>
                            <span style="background:#f0f0f0; padding:1px 3px; border-radius:3px; font-size: 0.9em;"><%=r.mac%></span><br>
                            <span style="font-size:0.85em; color:<% if r.ip_type=='静态绑定' then %>#28a745<% else %>#6c757d<% end %>;"><%=r.ip_type%></span>
                        </td>
                        <td class="cbi-section-table-cell center">
                            <input type="button" class="cbi-button cbi-button-edit" value="修改" onclick="editR('<%=r.hostname%>','<%=r.name%>','<%=r.mac%>','<%=r.dest_ip%>','<%=r.src_ip_display%>','<%=r.src_dport%>','<%=r.dest_port%>')">
                            <input type="button" class="cbi-button cbi-button-remove" value="删除" onclick="delR('<%=r.index%>','<%=r.mac_id%>')">
                        </td>
                    </tr>
                    <% rowstyle = (rowstyle == 1) and 2 or 1 %>
                    <% end %>
                <% else %>
                    <tr class="cbi-section-table-row"><td colspan="5" class="center" style="color:#999;">暂无匹配的规则</td></tr>
                <% end %>
            </table>
        </div>
    </fieldset>
</div>

<script type="text/javascript">
(function(){
    var api_base = '<%=luci.dispatcher.build_url("admin", "network", "rdp_manager")%>';
    var msg_box = document.getElementById('sys_msg');
    var log = function(txt) { msg_box.innerText = txt; };

    // 将 Lua 的 known_hosts 渲染为 JS 字典方便快速索引查询
    var knownHostsMap = {
    <% if known_hosts then for _, h in ipairs(known_hosts) do %>
        "<%=h.ip%>": { mac: "<%=h.mac%>", name: "<%=h.name%>" },
    <% end end %>
    };

    // 监听下拉框改变，自动填入关联的输入框
    window.autoFillHost = function(ip) {
        if (ip !== "") {
            document.getElementById('f_int_ip').value = ip;
            if (knownHostsMap[ip]) {
                document.getElementById('f_mac').value = knownHostsMap[ip].mac;
                document.getElementById('f_hostname').value = knownHostsMap[ip].name;
            }
        }
    };

    window.editR = function(h, n, m, ip, w, p, dp) {
        document.getElementById('f_hostname').value = (h === '无解析' ? '' : h);
        document.getElementById('f_name').value = n;
        document.getElementById('f_mac').value = m;
        document.getElementById('f_int_ip').value = ip;
        document.getElementById('f_wan_ip').value = (w === '不限' ? '' : w);
        document.getElementById('f_ext_port').value = p;
        document.getElementById('f_int_port').value = dp;
        
        // 当点击修改时，若有匹配的 IP 也同步选中下拉框
        document.getElementById('sel_int_ip').value = knownHostsMap[ip] ? ip : "";
        
        window.scrollTo(0, 0); 
    };

    window.delR = function(fid, mid) {
        if(!confirm('危险操作：确定要删除该规则及其绑定的静态IP吗？')) return;
        log('正在执行删除指令...');
        var fd = new URLSearchParams();
        fd.append('fw_idx', fid);
        fd.append('mac_id', mid);
        fetch(api_base + '/delete', {
            method: 'POST', 
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: fd
        }).then(function(){ location.reload(); });
    };

    window.submitRule = function(type) {
        var form = document.getElementById('rdp_form');
        var data = new FormData(form);
        
        if(type === 'fw' || type === 'apply') {
            if(!data.get('name') || !data.get('ext_port') || !data.get('int_port')) {
                log('错误：规则名、内网端口和外部映射端口均为必填项！'); return;
            }
        }
        if(type === 'dhcp' || type === 'apply') {
            if(!data.get('mac') || !data.get('int_ip')) {
                log('错误：MAC地址和内网IP为必填项！'); return;
            }
        }

        log('配置下发中，请稍候...');
        var endpoint = (type === 'apply') ? '/apply' : '/set_' + type;
        fetch(api_base + endpoint, {
            method: 'POST', body: data
        }).then(function(){
            setTimeout(function(){ location.reload(); }, 1500);
        }).catch(function(){ log('网络连接异常'); });
    };
})();
</script>

<%+footer%>